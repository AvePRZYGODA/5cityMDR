<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wasu's comic library</title>
    <link rel="icon" type="image/png" href="https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/240/twitter/322/open-book_1f4d6.png">
    <style>
        body {
            background-color: bisque;
            color: darkslategray;
        }
        p#demo img {
            width: 200px;
        }

        #demo {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            justify-content: center;
            text-align: center;
            font-weight: bold;
        }

        #demo div {
            width: 220px;
            height: auto;
            margin: 5px;
            padding: 5px;
            padding-top: 15px;
        }

        #demo div:hover {
            background-color:lightsteelblue;
        }
        
        #demo div img {
        	min-height: 50px;
        }

        #progressbar {
            width: 0;
            position: fixed;
            top: 0;
            left: 0;
            border-top: 5px solid #00B0F0;
        }
        
        #motto {
        	text-align: center;
            font-style: italic;
            margin: 20px;
        }
        
        #seealso {
        	position: sticky;
        	top: 7px;
        }
        
    </style>
</head>

<body>
    <div id="progressbar"></div>
    <p id="motto"><b>MOTTO</b><br>“All these cursed things I've read... watched... It was all for the plot. Always has been.”</p>
    <p id="seealso">
    	<a href="BDSM.html"><img src="https://img.shields.io/badge/see_also-BDSM_comics_collection-blue?style=social"/></a> 
		<a href="wholesome.html"><img src="https://img.shields.io/badge/see_also-wholesome-blue?style=social"/></a> 
	</p>
    <p id="demo"></p>

    <script>

        async function fetchComics() {
            const response = await fetch('https://api.github.com/repos/wsu808/wsu_cubari/contents/');
            const comicLinks = await response.json();
            const DOM = document.getElementById('demo');
            for (var i = 0; i < comicLinks.length; i++) {
                if (comicLinks[i].name.includes(".json")) {
                
                	var elem_comic = document.createElement('div');
                	
                	var elem_href = document.createElement('a');
                	var cubariLink = getCubariURL(comicLinks[i].download_url);
                	elem_href.href = cubariLink;
                	elem_href.target = '_blank';
                
                	const meta = await getMeta(comicLinks[i].download_url);
                
                	var elem_img = document.createElement('img');
                	elem_img.src = meta[0];
                	elem_img.alt = 'COVER for: ' + meta[1];
			// Add the onerror attribute to handle the case when the original image fails to load
                        elem_img.onerror = function() {
                            this.onerror = null; // Unbind the onerror event to prevent looping
                            this.src = 'https://via.placeholder.com/512x768.jpg?text=%3Cno_cover%3E'; // Set the fallback image URL
                        };
			
                	var elem_text = document.createTextNode(meta[1]);
                
                	elem_href.appendChild(elem_img);
                	elem_href.appendChild(document.createElement('br'));
                	elem_href.appendChild(elem_text);
                	elem_comic.appendChild(elem_href);
                	DOM.appendChild(elem_comic);
                } 
                //progressbar
                var progress = i*100/comicLinks.length;
                if(progress>95) {
                    document.getElementById('progressbar').style.display = 'none';
                } else {
                    document.getElementById('progressbar').style.width = progress + '%';
                }
                
            }
        }
        fetchComics().then(data => { data })

        function getCubariURL(URL) {
            var cubariLink = URL.replace('https://raw.githubusercontent.com', '');
            cubariLink = 'raw' + cubariLink;
	    // Convert the string to Uint8Array
	    const bytes = new TextEncoder().encode(cubariLink);
            // Encode the Uint8Array using btoa
            const encoded = btoa(String.fromCharCode(...bytes));
            cubariLink = 'https://cubari.moe/read/gist/' + encoded;
            return cubariLink;
        }
        
        async function getMeta(URL) {
            const response = await fetch(URL);
            const data = await response.json();
            var cover = data.cover ? data.cover : 'https://via.placeholder.com/512x768.jpg?text=<no_cover>' ;
            var title = data.title ? data.title : 'title not specified';
            return [cover, title];
        }



    </script>

</body>

</html>
